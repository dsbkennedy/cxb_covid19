---
title: 'COVID-19  Dashboard:Cox’s Bazar, Bangladesh'
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: bootstrap
editor_options: 
  chunk_output_type: console
---
```{r global, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, error=TRUE)
```

```{r setup_import, include=FALSE}

##Load required packages

library(lubridate)
library(here)
library(data.table)
library(dplyr)
library(janitor)
library(linelist)
library(forcats)
library(ggplot2)
library(ggthemes)
library(gt)
library(tidyr)
library(RcppRoll)
library(scales)
library(sf)
library(patchwork)
library(flexdashboard)
library(plotly)
library(ggupset)
library(table1)
library(ggpubr)
library(htmltools)
library(purrr)
library(googlesheets4)
library(here)
library(tidyr)
library(httr)
library(jsonlite)
library(magrittr)
library(tibble)
library(stringr)
library(leaflet)
library(tsibble)

##Load login information for Google Sheets & GoData
source(here('login.R'))

##Set ggplot to show numbers instead of scientific notation
options(scipen=10000)

##Import data from Google Sheets

gs4_deauth()
gsheet_data <- map(sheet_names, ~read_sheet(gdrive_link, sheet=.)) %>%  set_names(sheet_names)

##Import FDMN data 
fdmn_raw <- gsheet_data$fdmn %>% 
  clean_names() %>% 
    janitor::remove_empty() %>% 
     mutate(date_of_death=janitor::excel_numeric_to_date(date_of_death)) %>% 
    #select(-date_of_death) %>% 
  mutate(camp_of_residence=as.character(camp_of_residence))

##Import host data 
host_raw <- gsheet_data$host %>% 
  clean_names() %>% 
  janitor::remove_empty()

##Bind FDMN and host data
all_cases_raw <- fdmn_raw %>% 
  bind_rows(host_raw)

#Find all date columns
all_date_cols <- grep("(date|created_at| updated_on)", names(all_cases_raw))

#Process linelist data
all_cases_linelist <- all_cases_raw %>% clean_dates( force_Date  = all_date_cols,
                                                     guess_dates = all_date_cols) %>% 
  mutate(population_group=case_when(grepl('host', nationality, ignore.case=T)~ 'Host community',
                                    grepl('fdmn', nationality, ignore.case=T) ~ 'Rohingya refugee/FDMN')) %>% 
  mutate(upazilla=case_when(upazilla=='CXB Sadar' ~ 'Sadar', 
                            TRUE~upazilla)) %>% 
  filter(!(is.na(population_group))) 


## Testing data
tests_data <- gsheet_data$testing %>% 
  clean_names() 

test_nationality <- tests_data %>% 
    filter(!date %in% c('NULL', 'Total')) %>% 
    mutate(date_format=excel_numeric_to_date(as.numeric(date))) %>% 
    select(-date) %>% 
    pivot_longer(-date_format) %>% 
  mutate(population_group=case_when(grepl('fdmn',name) ~ 'Rohingya refugee/FDMN',
                                    grepl('host',name) ~ 'Host community')) 


##DRU data
dru_raw <- gsheet_data$dru %>% clean_names() %>%   mutate(facility_name=gsub(":([[:alpha:]])", ": \\1", facility_name)) 
quarantine_raw <- gsheet_data$quarantine %>% clean_names() %>% filter(!is.na(facility_name))


### Camp population file
population <- read.csv(here('data', 'population.csv')) 


### GoData

#get access token
url_request <- paste0(url,"api/oauth/token?access_token=123")

response <- POST(url=url_request,
                 body = list(
                   username = username,
                   password = password),
                 encode = "json")

content <-
  content(response, as = "text") %>%
  fromJSON(flatten = TRUE)

access_token <- content$response$access_token                 ## this is your access token !!! that allows API calls

#specify date ranges, for follow up filters
date_now <- format(Sys.time(), "%Y-%m-%dT23:59:59.999Z")
date_21d_ago <- format((Sys.Date()-21), "%Y-%m-%dT23:59:59.999Z")

# import outbreak Cases
response_cases <- GET(paste0(url,"api/outbreaks/",outbreak_id,"/cases"),
                      add_headers(Authorization = paste("Bearer", access_token, sep = " "))
)
json_cases <- content(response_cases, as = "text")


cases <- as_tibble(fromJSON(json_cases, flatten = TRUE)) %>% 
  select(-c(firstName,middleName,lastName, addresses))


#Save populations as objects for processing later on 
host_population <-  2805491
fdmn_population <-  859205 


```

```{r wranging_valuebox}


#Cases
cxb_cases <- all_cases_linelist %>% 
  group_by(population_group,date_of_case_detection) %>% 
  summarise(n = n(),.groups = 'drop') %>% 
  select(date=date_of_case_detection, population_group, new_cases=n)

#Deaths
cxb_deaths <- all_cases_linelist %>% 
  filter(x30_day_outcome=='Death') %>% 
  group_by(population_group,date_of_case_detection) %>% 
  summarise(n = n(),.groups = 'drop') %>% 
  select(date=date_of_case_detection, population_group, new_deaths=n)

#Tests
cxb_tests <- tests_data %>%  
  filter(!date %in% c('NULL', 'Total')) %>% 
  mutate(date_format=excel_numeric_to_date(as.numeric(date)))  %>% 
  select(date=date_format, fdmn, host,) %>% 
  pivot_longer(-date) %>% 
  select(date, population_group=name, new_tests=value) %>% 
  mutate(population_group=case_when(grepl('fdmn', population_group) ~ 'Rohingya refugee/FDMN',
                                    TRUE ~ 'Host community')) 

#Combine CXB data

cxb_table_data <- cxb_tests %>% 
  full_join(cxb_cases, by=c('population_group', 'date')) %>% 
  full_join(cxb_deaths, by=c('population_group', 'date')) %>% 
  mutate(population=case_when(population_group=='Rohingya refugee/FDMN' ~ fdmn_population, 
                              TRUE ~ host_population)) 
rm(cxb_cases, cxb_deaths,cxb_tests)

#Bangladesh data from Our World In Data
bgd_data <- fread('https://covid.ourworldindata.org/data/owid-covid-data.csv') %>% 
  filter(iso_code=='BGD') %>%        
  mutate(date_format=ymd(date)) %>% 
  select(date=date_format, new_tests,new_cases,new_deaths,population) %>% 
  mutate(population_group='Bangladesh')

#Get first date from Bangladesh data
first_date <- min(bgd_data$date)
#Last date is today
last_date <- today()



#Combine Bangaladesh and CXB data
table_final_df <- bgd_data %>% 
  bind_rows(cxb_table_data) %>% 
  arrange(date, population_group) %>% 
  ungroup()

rm(bgd_data, cxb_table_data)
#Totals
table_totals <- table_final_df %>% 
 # ungroup() %>% 
  group_by(population_group, population) %>% 
  summarise(total_tests=sum(new_tests, na.rm=TRUE),
            total_cases=sum(new_cases, na.rm=TRUE),
            total_deaths=sum(new_deaths, na.rm=TRUE)) %>% 
  mutate(total_tests_pm=(total_tests/population)*1*10E5,
         total_cases_pm=(total_cases/population)*1*10E5,
         total_deaths_pm=(total_deaths/population)*1*10E5) %>% 
  select(-population)

#7-day
table_7day <- table_final_df %>% 
 # ungroup() %>% 
  filter(date > today() -7) %>% 
  group_by(population_group, population) %>% 
  summarise(total_tests_7day=sum(new_tests, na.rm=TRUE),
            total_cases_7day=sum(new_cases, na.rm=TRUE),
            total_deaths_7day=sum(new_deaths, na.rm=TRUE)) %>% 
  mutate(total_tests_pm_7day=(total_tests_7day/population)*1*10E5,
         total_cases_pm_7day=(total_cases_7day/population)*1*10E5,
         total_deaths_pm_7day=(total_deaths_7day/population)*1*10E5)%>% 
  select(-population)

#Growth rate

growth_rate <- table_final_df %>% 
  group_by(population_group) %>% 
  mutate(new_cases=coalesce(new_cases,0)) %>% 
  mutate(cumulative_cases=cumsum(new_cases)) %>%
  mutate(case_growth=ifelse(lag(cumulative_cases,7)>10, 
                            ((cumulative_cases/lag(cumulative_cases,7))^(1/7))-1,NA)) %>%
                              summarise(case_growth=last(case_growth))

#Final calculations
table_calc_comb <- table_totals %>% 
  left_join(table_7day, by='population_group') %>% 
  left_join(growth_rate, by='population_group') %>% 
  mutate(test_pos=total_cases/total_tests, 
         cfr=total_deaths/total_cases)

rm(table_totals,table_7day,growth_rate)

```


Landing page
=====================================  
<br>

Row {data-height=75}
-------------------------------------

### 

```{r host_placeholder}
##Host community placeholder

 valueBox(
  format(paste0('Host community'), big.mark = ","),
  icon= "",
  color= "#ED7D31"
)

```


### Tests: Total (Last 7 days)

```{r host_tests}
##Host community tests

host_tests <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_tests)
host_tests_7day <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_tests_7day)

 valueBox(
  format(paste0(host_tests,' (', host_tests_7day, ')'), big.mark = ","),
  icon= "fas fa-vials",
  color= "#ED7D31"
)


```

### Cases: Total (Last 7 days)

```{r host_cases}
##Host community cases

host_cases <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_cases)
host_cases_7day <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_cases_7day)
               
 valueBox(
  format(paste0(host_cases,' (', host_cases_7day, ')'), big.mark = ","),
  icon = "fas fa-user-md",
  color= "#ED7D31"
)

```

### Deaths: Total (Last 7 days)

```{r host_deaths}
##Host community deaths

host_deaths <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_deaths)
host_deaths_7day <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_deaths_7day)
               
 valueBox(
  format(paste0(host_deaths,' (', host_deaths_7day, ')'), big.mark = ","),
  icon = "fas fa-procedures",
  color= "#ED7D31"
)


```

Row {data-height=75}
-------------------------------------

### 

```{r fdmn_placeholder}
##FDMN placeholder

 valueBox(
  format(paste0('Rohingya/FDMN'), big.mark = ","),
  icon= "",
  color= "#4472C4"
)

```



### Tests: Total (Last 7 days)

```{r fdmn_tests}
##FDMN tests

fdmn_tests <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_tests)
fdmn_tests_7day <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_tests_7day)
               
 valueBox(
  format(paste0(fdmn_tests,' (', fdmn_tests_7day, ')'), big.mark = ","),
  icon= "fas fa-vials",
  color= "#4472C4"
)

```

### Cases: Total (Last 7 days)

```{r fdmn_cases}
##FDMN cases

fdmn_cases <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_cases)
fdmn_cases_7day <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_cases_7day)
               
 valueBox(
  format(paste0(fdmn_cases,' (', fdmn_cases_7day, ')'), big.mark = ","),
  icon = "fas fa-user-md",
  color= "#4472C4"
)

```

### Deaths: Total (Last 7 days)

```{r fdmn_deaths}
##FDMN deaths

fdmn_deaths <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_deaths)
fdmn_deaths_7day <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_deaths_7day)
               
 valueBox(
  format(paste0(fdmn_deaths,' (', fdmn_deaths_7day, ')'), big.mark = ","),
  icon = "fas fa-procedures",
  color= "#4472C4"
)

```




Row {data-height=150}
-------------------------------------

### Tests

```{r tests_table}

table_calc_comb %>% 
  ungroup() %>%
  select(population_group, contains('test')) %>% 
  gt(rowname_col = "population_group") %>% 
  tab_stubhead(label = "Population group") %>% 
  cols_label(
    total_tests = "Total",
    total_tests_pm = "Per million",
    total_tests_7day = "Last 7 days", 
    total_tests_pm_7day   = "Per million",
    test_pos = "Test positivity" 
  ) %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  fmt_percent(
    columns = vars(test_pos),
    decimals = 1
  ) %>% 
  fmt_number(
    columns=vars(total_tests_pm,total_tests_pm_7day),
    decimals = 1
  )

```

### Cases

```{r cases_table}

table_calc_comb %>% 
  ungroup() %>%
  select(population_group, contains('case')) %>% 
  gt(rowname_col = "population_group") %>% 
  tab_stubhead(label = "Population group") %>% 
  cols_label(
    total_cases = "Total",
    total_cases_pm = "Per million",
    total_cases_7day = "Last 7 days",
    total_cases_pm_7day   = "Per million",
    case_growth = "Growth rate"
  ) %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  fmt_percent(
    columns = vars(case_growth),
    decimals = 1
  ) %>% 
  fmt_number(
    columns=vars(total_cases_pm, total_cases_pm_7day),
    decimals = 1
  )


```

### Deaths

```{r deaths_table}

table_calc_comb %>% 
  ungroup() %>%
  select(population_group, contains('death'), cfr) %>% 
  gt(rowname_col = "population_group") %>% 
  tab_stubhead(label = "Population group") %>% 
  cols_label(
    total_deaths = "Total",
    total_deaths_pm = "Per million", 
    total_deaths_7day = "Last 7 days",
    total_deaths_pm_7day  = "Per million", 
    cfr = "Case Fatality Risk"
  ) %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  fmt_percent(
    columns = vars(cfr),
    decimals = 1
  ) %>% 
  fmt_number(
    columns=vars(total_deaths_pm,total_deaths_pm_7day),
    decimals = 1
  )
```


Row {data-height=250}
-------------------------------------

### Cases by date  (Scales are different for each graph)


```{r epicurve_bgd_host_fdmn}

epi_curve <- table_final_df %>% 
  mutate(week=epiweek(date)) %>% 
ggplot(.) +
  geom_col(aes(x = date, y = new_cases)) +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '7 day',
               date_labels = '%d-%m') +
  theme_minimal() +
  labs(x = "Date case reported",
       y = "Number of cases") +
  facet_wrap(~ population_group, scales="free_y", ncol=1)

ggplotly(epi_curve)


```


### Test positivity trend

```{r test postivity_trend}
test_positivity_gph <- test_nationality %>% 
  filter(name %in% c('host', 'fdmn','host_positive', 'fdmn_positive')) %>% 
  mutate(week=epiweek(date_format)) %>% 
  filter(week>=19) %>% 
  mutate(population_group=factor(population_group)) %>% 
  mutate(indicator=case_when(grepl('positive', name) ~ 'Case', 
                             TRUE ~ 'Test')) %>% 
  select(-c(name)) %>% 
  pivot_wider(names_from=indicator) %>% 
  group_by(population_group) %>% 
  mutate(tests_roll=roll_mean((Test),7, na.rm=TRUE, align="right", fill = NA)) %>% 
  mutate(cases_roll=roll_mean((Case),7, na.rm=TRUE, align="right", fill = NA)) %>% 
  mutate(pos_roll=cases_roll/tests_roll) %>% 
  ggplot(., aes(x=date_format, y=pos_roll, color=population_group)) +
  geom_line()  +
  scale_fill_manual(values=c("#ED7D31","#4472C4")) +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '7 day',
               date_labels = '%d-%m') +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(caption="Data source: Lab data",
       x = "Date of test",
       y = "Test positivity (%) (7-day average)",
       color="Population group") +
  theme_minimal()

ggplotly(test_positivity_gph)

```



Row {data-height=75}
-------------------------------------

### Additional Resources


  + [WHO Bangaladesh Rohingya Crisis](https://www.who.int/bangladesh/emergencies/Rohingyacrisis/bulletin-and-reports){target="_blank"}

  + [SOPs](https://ln2.sync.com/dl/f29c53860/2hqhzj3x-q476hijz-sf8admz2-9b8793y9){target="_blank"}
  
  + [Field manuals](https://ln2.sync.com/dl/77f93df70/czt8mutv-8rcug6ge-erffrmd5-5s9i76c3){target="_blank"}
  
  + [Infographics](https://ln2.sync.com/dl/8da6ec810/f8q6b3c7-vgnyxh76-cepdkgqu-e2q4d9na){target="_blank"}
  
  + [Healthcare facility monitoring (Live Dashboard)](https://worldhealthorg.shinyapps.io/cxb_dru_dashboard){target="_blank"}
  

### Partners





```{r, echo=FALSE,fig.cap="This dashboard was developed by WHO Cox’s Bazar in collaboration with the [UK Public Health Rapid Support Team](https://www.lshtm.ac.uk/research/centres-projects-groups/uk-phrst){target='_blank'}", fig.align='center'} 

knitr::include_graphics(here('data', 'logo_comb.png'))

##Time in Bangladesh
s <- now("UTC-6")

```






### Contact details

If you have any questions contact kennedyd@who.int




Data updated at - "`r s`"


```{r data_wrangling_subdistrict}

##Calculate across all data and then separate by Host & FDMN at a later stage

#Cases
cxb_cases_subloc <- all_cases_linelist %>% 
  group_by(population_group,date_of_case_detection,upazilla, camp_of_residence) %>% 
  summarise(n = n(),.groups = 'drop') %>% 
  select(date=date_of_case_detection, population_group,upazilla, camp_of_residence, new_cases=n)

#Deaths
cxb_deaths_subloc <- all_cases_linelist %>% 
  filter(x30_day_outcome=='Death') %>% 
  group_by(population_group,date_of_case_detection,upazilla, camp_of_residence) %>% 
  summarise(n = n(),.groups = 'drop') %>% 
  select(date=date_of_case_detection, population_group,upazilla, camp_of_residence, new_deaths=n)

cxb_cases_deaths_subloc <- cxb_cases_subloc %>% 
  full_join(cxb_deaths_subloc, by=c('population_group', 'date', 'upazilla', 'camp_of_residence')) %>% 
  mutate(location=coalesce(as.character(camp_of_residence),upazilla)) %>% 
  full_join(., population, by='location') %>% 
  filter(!is.na(population_group))

rm(cxb_cases_subloc, cxb_deaths_subloc)

#Totals
table_totals_subloc <- cxb_cases_deaths_subloc %>% 
  ungroup() %>% 
  group_by(population_group, population, location) %>% 
  summarise(total_cases=sum(new_cases, na.rm=TRUE),
            total_deaths=sum(new_deaths, na.rm=TRUE)) %>% 
  mutate(total_cases_pm=(total_cases/population)*1*10E5,
         total_deaths_pm=(total_deaths/population)*1*10E5) %>% 
    ungroup() %>% 
  select(-population)

#7-day
table_7day_subloc <- cxb_cases_deaths_subloc %>% 
  ungroup() %>% 
  filter(date > today() -7) %>% 
  group_by(population_group, population, location) %>% 
  summarise(total_cases_7day=sum(new_cases, na.rm=TRUE),
            total_deaths_7day=sum(new_deaths, na.rm=TRUE)) %>% 
  mutate(total_cases_pm_7day=(total_cases_7day/population)*1*10E5,
         total_deaths_pm_7day=(total_deaths_7day/population)*1*10E5)%>% 
  ungroup() %>% 
  select(-population)


#Growth rate
##Growth rate needs values larger than 10 so FDMN communities don't reach this criteria
growth_rate_subloc <- cxb_cases_deaths_subloc %>% 
  group_by(population_group,location) %>% 
  mutate(new_cases=coalesce(new_cases,0)) %>% 
  mutate(cumulative_cases=cumsum(new_cases)) %>%
  mutate(case_growth=ifelse(lag(cumulative_cases,7)>10, 
                            ((cumulative_cases/lag(cumulative_cases,7))^(1/7))-1,NA)) %>%
  summarise(case_growth=last(case_growth)) 


#Final calculations
table_calc_comb_subloc <- table_totals_subloc %>% 
  left_join(table_7day_subloc, by=c('population_group','location')) %>% 
  left_join(growth_rate_subloc, by=c('population_group','location')) %>% 
  mutate( cfr=total_deaths/total_cases)

rm(table_totals_subloc, table_7day_subloc,growth_rate_subloc)


```




Host community  {data-orientation=columns}
=====================================  

Row 
-------------------------------------
   
### Table {data-height=500}


```{r host_cases_deaths_table}
host_table_data <- table_calc_comb %>% 
  filter(grepl('host', population_group, ignore.case = T)) %>% 
  mutate(location="Total") %>% 
  select(c(population_group,location,total_cases,total_deaths,total_cases_pm,total_deaths_pm,total_cases_7day,total_deaths_7day,   
 total_cases_pm_7day,total_deaths_pm_7day,case_growth,cfr)) 

#Host 
summaryTable_host <- table_calc_comb_subloc %>% 
  ungroup() %>%
  filter(grepl('host', population_group, ignore.case=T)) %>% 
  bind_rows(host_table_data) %>% 
  select(-c(population_group,total_deaths_pm,total_deaths_pm_7day)) %>% 
  gt() %>% 
  cols_label(
    location = "Upazilla",
    total_cases = "Total",
    total_deaths = "Total",
    total_cases_pm = "Per million",
    total_cases_7day = "Last 7 days",
    total_deaths_7day = "Last 7 days",
    total_cases_pm_7day   = "Per million",
    cfr = "Case Fatality Risk", 
    case_growth = "Growth rate"
  ) %>% 
  tab_spanner(
    label = "Cases",
    columns = vars(total_cases, total_cases_pm,total_cases_7day,total_cases_pm_7day,case_growth)
  ) %>% 
  tab_spanner(
    label = "Deaths",
    columns = vars(total_deaths,total_deaths_7day, cfr)
  ) %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  fmt_percent(
    columns = vars(case_growth, cfr),
    decimals = 1
  ) %>% 
  fmt_number(
    columns=vars(total_cases_pm, total_cases_pm_7day),
    decimals = 1
  ) %>% 
  tab_source_note("Data Source: FDMN/Host Linelist") %>% 
  tab_options(
    container.overflow.x = TRUE,
    container.overflow.y = TRUE,
    grand_summary_row.background.color = "lightblue")

summaryTable_host
```   

### Tests and cases over time {data-height=500}

```{r host_tests_cases_gph}

testing_host_gph <-  test_nationality %>% 
      filter(name %in% c('host', 'host_positive')) %>% 
       mutate(name_fac=factor(name,levels=c('host', 'host_positive'), 
                         labels=c('Tests', 'Cases'))) %>% 
  ggplot(., aes(x=date_format, y=value, fill=name_fac)) +
  geom_bar(stat="identity",position ="identity")   +
    scale_fill_manual(values=c("#ED7D31","#4472C4")) +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '3 day',
               date_labels = '%d-%m') +
  labs(caption="Data source: Lab data",
       x = "Date",
       y = "Count",
       fill="") +
  theme_minimal()

ggplotly(testing_host_gph)


```



Column 
-------------------------------------


### Map


```{r host_map}


shp_file_host <- read_sf(here('data', 'shapefiles', 'cxb_shp.shp'))


case_shp_host <- table_calc_comb_subloc %>% 
  filter(population_group=='Host community') %>% 
  rename(upazilla = location) %>% 
  select(upazilla,total_cases, total_deaths) %>% 
  left_join(shp_file_host,.,by='upazilla') %>%    mutate(total_cases=ifelse(total_cases==0, NA, total_cases)) %>% 
  mutate(total_deaths=ifelse(total_deaths==0, NA, total_deaths))

#Define colour palettes based on available data
#This will need to be updated as cases increase
host_pal_cases_bins <-c(0, 100, 250, 500, 1000, 2500)
host_pal_deaths_bins <-c(0, 5, 10, 25, 50)


host_pal_cases <- colorBin( "YlGn", bins=host_pal_cases_bins, na.color = "grey", pretty=FALSE)
host_pal_deaths <- colorBin( "PuRd", bins=host_pal_deaths_bins, na.color = "grey", pretty=FALSE)


host_popup <- paste(
  "<strong>Upazila: </strong>"
  , case_shp_host$upazilla
  , "<br><strong>Cases: </strong>"
  , case_shp_host$total_cases
  , "<br><strong>Deaths: </strong>"
  , case_shp_host$total_deaths
)

leaflet(case_shp_host) %>% 
  addTiles() %>% 
  addPolygons(data=case_shp_host,
              color="black",
              fillColor = ~ host_pal_cases(total_cases),
              stroke = TRUE,   
              smoothFactor = 0.2,
              popup=host_popup,
              weight = 1,
              fillOpacity = .6, group="Cases") %>% 
  addLegend(pal = host_pal_cases, values = ~total_cases, title = "Cases", group="Cases") %>% 
  addPolygons(data=case_shp_host,
              color="black",
              fillColor = ~ host_pal_deaths(total_deaths),
              stroke = TRUE,   
              smoothFactor = 0.2,
              popup=host_popup,
              weight = 1,
              fillOpacity = .6, group="Deaths") %>% 
  addLegend(pal = host_pal_deaths, values = ~total_deaths, title = "Deaths", group="Deaths") %>% 
  addLayersControl(baseGroups = c("Cases", "Deaths"), 
                   position = "topleft",
                   options = layersControlOptions(collapsed=F)) %>% hideGroup("Deaths")



```


 
 
Rohingya refugee/FDMN {data-orientation=columns}
=====================================  

Row 
-------------------------------------
   
### Table {data-height=500}
    
```{r fdmn_table}

# prepare regular expression for extracting camp number from camp variable
regexp <- "[[:digit:]]+"

fdmn_table_data <- table_calc_comb %>% 
  filter(grepl('fdmn', population_group, ignore.case = T)) %>% 
  mutate(location="Total") %>% 
  select(c(population_group,location,total_cases,total_deaths,total_cases_pm,total_deaths_pm,total_cases_7day,total_deaths_7day,   
           total_cases_pm_7day,total_deaths_pm_7day,case_growth,cfr)) 

#FDMN 
summaryTable_fdmn <- table_calc_comb_subloc %>% 
  ungroup() %>%
  filter(grepl('fdmn', population_group, ignore.case=T)) %>% 
  bind_rows(fdmn_table_data) %>% 
  mutate(location=case_when(grepl('ukhia', location, ignore.case=T)~'Camp missing (Ukhia)',
                            grepl('teknaf', location, ignore.case=T)~'Camp missing (Teknaf)',
                            TRUE ~ location)) %>% 
  mutate(total_cases_pm=ifelse(grepl('ukhia', location, ignore.case=T),NA, 
                               ifelse(grepl('teknaf', location, ignore.case=T), NA, total_cases_pm))) %>% 
  mutate(total_cases_pm_7day=ifelse(grepl('ukhia', location, ignore.case=T),NA, 
                                    ifelse(grepl('teknaf', location, ignore.case=T), NA, total_cases_pm_7day))) %>% 
  mutate(camp=location) %>% 
  mutate(camp_number=str_extract(camp, regexp)) %>% 
  mutate(camp_number=as.numeric(camp_number)) %>% 
  arrange(camp_number) %>% 
  select(-c(population_group,camp,total_deaths_pm,total_deaths_pm_7day,camp_number)) %>% 
  gt() %>% 
  cols_label(
    location = "Camp",
    total_cases = "Total",
    total_deaths = "Total",
    total_cases_pm = "Per million",
    total_cases_7day = "Last 7 days",
    total_deaths_7day = "Last 7 days",
    total_cases_pm_7day   = "Per million",
    cfr = "Case Fatality Risk", 
    case_growth = "Growth rate"
  ) %>% 
  tab_spanner(
    label = "Cases",
    columns = vars(total_cases, total_cases_pm,total_cases_7day,total_cases_pm_7day,case_growth)
  ) %>% 
  tab_spanner(
    label = "Deaths",
    columns = vars(total_deaths,total_deaths_7day, cfr)
  ) %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  fmt_percent(
    columns = vars(case_growth, cfr),
    decimals = 1
  ) %>% 
  fmt_number(
    columns=vars(total_cases_pm, total_cases_pm_7day),
    decimals = 1
  ) %>% 
  tab_source_note("Data Source: FDMN/Host Linelist") %>% 
  tab_options(
    container.overflow.x = TRUE,
    container.overflow.y = TRUE,
    grand_summary_row.background.color = "lightblue") %>% 
  fmt_missing(
    columns = 2:8,
    missing_text = "-"
  ) %>% 
  tab_footnote(
    footnote = "Growth rate can only be calculated when there have been at least 10 cases",
    locations = cells_column_labels(
      columns = vars(case_growth))
  )


summaryTable_fdmn
```


### Tests and cases over time {data-height=500}

```{r fdmn_tests_cases}

testing_fdmn_gph <-  test_nationality %>% 
  filter(name %in% c('fdmn', 'fdmn_positive')) %>% 
       mutate(name_fac=factor(name,levels=c('fdmn', 'fdmn_positive'), 
                         labels=c('Tests', 'Cases'))) %>% 
  ggplot(., aes(x=date_format, y=value, fill=name_fac)) +
  geom_bar(stat="identity",position ="identity")   +
    scale_fill_manual(values=c("#ED7D31","#4472C4")) +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '3 day',
               date_labels = '%d-%m') +
  labs(caption="Data source: Lab data",
       x = "Date",
       y = "Count",
       fill="") +
  theme_minimal()


ggplotly(testing_fdmn_gph)
```



Column 
-------------------------------------

### Map

```{r fdmn_map}

shp_file_fdmn <- read_sf(list.files(here('data','shapefiles'), 
                                    pattern='1.shp$', 
                                    full.names = T)) %>% 
  
  clean_names() %>% 
  mutate(merge_col = case_when(code=='KRC' ~ 'Kutupalong RC',
                               code=='NRC' ~ 'Nyapara RC', 
         TRUE ~ code))

case_shp_fdmn <- table_calc_comb_subloc %>% 
  filter(population_group=='Rohingya refugee/FDMN') %>% 
  filter(!location %in% c('Ukhia', 'Teknaf')) %>% 
  mutate(code=location) %>% 
  select(code,total_cases, total_deaths) %>% 
  left_join(shp_file_fdmn,.,by=c('merge_col'='code')) %>% 
    mutate(total_cases=ifelse(total_cases==0, NA, total_cases)) %>% 
  mutate(total_deaths=ifelse(total_deaths==0, NA, total_deaths))

fdmn_pal_cases_bins <-c(0, 1, 2, 5, 10)
fdmn_pal_deaths_bins <-c(0, 1, 2)


fdmn_pal_cases <- colorBin( "YlGn", bins=fdmn_pal_cases_bins, na.color = "grey", pretty=FALSE)
fdmn_pal_deaths <- colorBin( "PuRd", bins=fdmn_pal_deaths_bins, na.color = "grey", pretty=FALSE)


fdmn_popup <- paste(
  "<strong>Camp: </strong>"
  , case_shp_fdmn$code
  , "<br><strong>Cases: </strong>"
  , case_shp_fdmn$total_cases
  , "<br><strong>Deaths: </strong>"
  , case_shp_fdmn$total_deaths
)

leaflet(case_shp_fdmn) %>% 
  addTiles() %>% 
  addPolygons(data=case_shp_fdmn,
              color="black",
              fillColor = ~ fdmn_pal_cases(total_cases),
              stroke = TRUE,   
              smoothFactor = 0.2,
              popup=fdmn_popup,
              weight = 1,
              fillOpacity = .6, group="Cases") %>% 
  addLegend(pal = fdmn_pal_cases, values = ~total_cases, title = "Cases", group="Cases") %>% 
  addPolygons(data=case_shp_fdmn,
              color="black",
              fillColor = ~ fdmn_pal_deaths(total_deaths),
              stroke = TRUE,   
              smoothFactor = 0.2,
              popup=fdmn_popup,
              weight = 1,
              fillOpacity = .6, group="Deaths") %>% 
  addLegend(pal = fdmn_pal_deaths, values = ~total_deaths, title = "Deaths", group="Deaths") %>% 
  addLayersControl(baseGroups = c("Cases", "Deaths"), 
                   position = "topleft",
                   options = layersControlOptions(collapsed=F)) %>% hideGroup("Deaths")





```




Epidemiology {data-orientation=columns}
=====================================  

Inputs {.sidebar}
-------------------------------------

<br>
<br>

This section displays data from GoData. The data are only for the FDMN/Rohingya population. 

<br> 

If there is a difference between the number of cases in this section and the number of cases on the "Landing page", the data have not 
yet been added to GoData.


<br>


```{r godata_wrangling}

godata_wide <- cases %>%
  clean_names() %>% 
  filter(deleted == FALSE) %>%
  unnest(c(
    #addresses,
    date_ranges,
    questionnaire_answers_health_facility,
    questionnaire_answers_status_at_detection,
    questionnaire_answers_outcome,
    questionnaire_answers_outcome_2,
    questionnaire_answers_msf_outcome,
    contains('nationality'),
    contains('result'),
    contains('symptom')
  ),
  keep_empty = TRUE, names_sep = "_") %>% 
    remove_empty(c("rows", "cols")) 


###Clean up GoData

##Define age groups for GoData
age_labs <- c(paste(seq(0, 50, by = 10), seq(9, 59, by = 10),
                    sep = "-"), paste(60, "+", sep = ""))

godata_clean <- godata_wide %>% 
  #Ethnicity
  mutate(population_group=coalesce(questionnaire_answers_nationality_value,questionnaire_answers_nationality_2_value,questionnaire_answers_cif_nationality_value)) %>% 
  filter(population_group=='FDMN')  %>% 
  #Test result
  mutate(lab_result=coalesce(questionnaire_answers_lab_result_value,questionnaire_answers_result_2_value)) %>% 
  #Some records don't have lab data in GoData. These are dropped when filter==positive
    mutate(lab_result=case_when(visual_id %in% c("CXB3310283", "CXB3310414", 
                                                 "CXB5310154", "CXB4950010",
                                                 "CXB3310590", "CXB5310243",
                                                 "CXB2120064","CXB3310451", 
                                                 "CXB3310542", "CXB3310603", 
                                                 "CXB3830005","CXB2008001") ~ 'Positive',
                              TRUE ~ lab_result)) %>% 
  filter(lab_result=='Positive') %>% 
  #Dates
  mutate(date_of_reporting = guess_dates(date_of_reporting),
         #date_of_data_entry = guess_dates(createdat),
         date_of_onset = guess_dates(date_of_onset),
         date_of_outcome = guess_dates(date_of_outcome),
         date_of_last_contact = guess_dates(date_of_last_contact),
         date_become_case = guess_dates(date_become_case)) %>% 
  #Age
  mutate(age_years = case_when(
    is.na(age_years) && !is.na(age_months) ~  as.integer(age_months / 12),
    #is.na(age_years) && is.na(age_months) ~  NA_integer_,
    TRUE ~ as.integer(age_years))) %>%
  #Age group
  mutate(age_group=cut(age_years,breaks = c(seq(0, 60, by = 10), Inf), labels = age_labs, right = FALSE)) %>%
  mutate(age_group=fct_explicit_na(age_group, na_level = "(outcome missing)")) %>% 
  #Classification
  filter(classification != "lng_reference_data_category_case_classification_not_a_case_discarded") %>%
  mutate(classification = case_when(
        grepl('confirmed', classification, ignore.case=TRUE) ~ "confirmed",
            grepl('suspect', classification, ignore.case=TRUE) ~ "suspect",
            grepl('probable', classification, ignore.case=TRUE) ~ "probable"
  )) %>%
  #Sex
  mutate(sex = case_when(
                grepl('_male', gender, ignore.case=TRUE) ~ "Male",
        grepl('_female', gender, ignore.case=TRUE) ~ "Female", 
        visual_id=="CXB3310202" ~ 'Female',
  )) %>% 
   mutate(sex=factor(sex, levels=c('Male', 'Female'))) %>% 
  #Updated this classification to match survey
  #updated to "outcome"
  mutate(outcome = case_when(
            grepl('alive', outcome_id, ignore.case=TRUE) ~ "Alive",
            grepl('deceased', outcome_id, ignore.case=TRUE) ~ "Dead",
            grepl('recovered', outcome_id, ignore.case=TRUE) ~ "Recovered",
            #grepl('death', questionnaire_answers_outcome, ignore.case=TRUE) ~ "dead",
            grepl('healthy', questionnaire_answers_outcome_2_value, ignore.case=TRUE) ~ "Alive",
            grepl('not recovered', questionnaire_answers_outcome_2_value, ignore.case=TRUE) ~ "Alive",
            grepl('$recovered', questionnaire_answers_outcome_2_value, ignore.case=TRUE) ~ "Recovered",
            questionnaire_answers_msf_outcome_value=='Recovered' ~ 'Recovered',
            questionnaire_answers_outcome_2_value=='Recovered' ~ 'Recovered',
            grepl('death', questionnaire_answers_outcome_2_value, ignore.case=TRUE) ~ "Dead", 
            visual_id %in% c("CXB3310414","CXB3310590","CXB2120064") ~ 'Alive',
  )) %>%
   #     mutate(outcome=fct_explicit_na(outcome, na_level = "(Outcome missing)"))  %>% 
  #Status at detection
  mutate(detection_status = questionnaire_answers_status_at_detection_value) %>%
  #Risk level
  mutate(risk_level = case_when(
            grepl('low', risk_level, ignore.case=TRUE) ~ "low",
            grepl('medium', risk_level, ignore.case=TRUE) ~ "medium",
            grepl('high', risk_level, ignore.case=TRUE) ~ "high"
  )) %>%
  #Updated available options
  mutate(status = case_when(
                grepl('hospitalization', date_ranges_typeId, ignore.case=TRUE) ~ "hospitalization",
                grepl('other', date_ranges_typeId, ignore.case=TRUE) ~ "other",
                grepl('isolation', date_ranges_typeId, ignore.case=TRUE) ~ "isolation"
  )) %>%
  mutate(pregnant = case_when(grepl('trimester', pregnancy_status, ignore.case=TRUE) ~ "Yes",
                    grepl('yes',questionnaire_answers_pregnant,ignore.case=TRUE)~ "Yes",
                    (sex=='Female' & age_years>=15) ~ 'No',
                    sex=='Male' ~ 'Not applicable',
                    age_years<15 ~ 'Not applicable',
                    age_years>50 ~ 'Not applicable')) %>% 
  #Symptoms
  #Cough
  mutate(cough=case_when(grepl('cough',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                         grepl('yes', questionnaire_answers_cough,ignore.case=TRUE)~1)) %>% 
  #Rapid breathing 
  mutate(rapid_breathing=case_when(grepl('rapid breathing',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                         grepl('yes', questionnaire_answers_rapid_breathing,ignore.case=TRUE)~1)) %>%
  #Respiratory distress
  mutate(resp_distress=case_when(grepl('severe respiratory distress',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_acute_respiratory_distress_syndrome_ards,ignore.case=TRUE)~1)) %>% 
  #Runny nose
  mutate(runny_nose=case_when(grepl('Runny nose',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                                 grepl('yes', questionnaire_answers_runny_nose,ignore.case=TRUE)~1)) %>% 
  #Fever
  mutate(fever=case_when(grepl('Fever',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_fever,ignore.case=TRUE)~1)) %>% 
  #Loss of smell 
  mutate(loss_smell=case_when(grepl('Loss of smell',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_loss_of_smell,ignore.case=TRUE)~1)) %>% 
  #Fatigue
  mutate(fatigue=case_when(grepl('Fatigue',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_fatigue,ignore.case=TRUE)~1)) %>% 
    #Loss of appetite
  mutate(loss_appetite=case_when(grepl('Loss of appetite',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_loss_of_appetite,ignore.case=TRUE)~1)) %>% 
     #Sore throat
  mutate(sore_throat=case_when(grepl('Sore throat',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_sore_throat,ignore.case=TRUE)~1)) %>% 
  #Diarrhoea
    mutate(diarrhoea=case_when(grepl('Diarrhoea',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_diarrhoea,ignore.case=TRUE)~1)) %>% 
  #Pre-existing conditions
  #Hypertension
  mutate(htn=case_when(grepl('hypertension',questionnaire_answers_select_pre_existing_medical_condition,ignore.case=TRUE)~1,
                         grepl('yes', questionnaire_answers_hypertension,ignore.case=TRUE)~1)) %>% 
  #Cardiovascular
  mutate(cardiovascular=case_when(grepl('cardiovascular',questionnaire_answers_select_pre_existing_medical_condition,ignore.case=TRUE)~1,
                       grepl('yes', questionnaire_answers_cardiovascular_disease,ignore.case=TRUE)~1)) %>% 
  #Diabetes
  mutate(diabetes=case_when(grepl('diabetes',questionnaire_answers_select_pre_existing_medical_condition,ignore.case=TRUE)~1,
                       grepl('yes', questionnaire_answers_diabetes,ignore.case=TRUE)~1)) %>% 
  #Lung disease
  mutate(lung_disease=case_when(grepl('chronic lung',questionnaire_answers_select_pre_existing_medical_condition,ignore.case=TRUE)~1,
                       grepl('yes', questionnaire_answers_chronic_lung_disease,ignore.case=TRUE)~1)) %>% 
    #Kidney disease
  mutate(kidney_disease=case_when(grepl('kidney',questionnaire_answers_select_pre_existing_medical_condition,ignore.case=TRUE)~1,
                       grepl('yes', questionnaire_answers_kidney_failure,ignore.case=TRUE)~1)) %>% 
      #Neurological disease
  mutate(neuro_disease=case_when(grepl('neuro',questionnaire_answers_select_pre_existing_medical_condition,ignore.case=TRUE)~1,
                       grepl('yes', questionnaire_answers_chronic_neuro_condition,ignore.case=TRUE)~1)) %>% 
  mutate(any_comorb=case_when(htn==1 ~ 'Yes',
                              cardiovascular==1 ~ 'Yes',
                              diabetes==1 ~ 'Yes',
                              lung_disease==1 ~ 'Yes', 
                              kidney_disease==1 ~ 'Yes',
                              neuro_disease ==1~ 'Yes', 
                              TRUE ~ 'No')) %>% 
  mutate(any_comorb=factor(any_comorb, levels=c('Yes','No'))) %>% 
  #Time intervals
   unnest(questionnaire_answers_date_sample_collected,   keep_empty = TRUE, names_sep = "_") %>% 
  #Date of onset
  mutate(date_symptom_onset_final=ymd(date_of_onset)) %>% 
  #Date sample collected
  mutate(date_sample_collected=ymd_hms(questionnaire_answers_date_sample_collected_value)) %>% 
  mutate(date_sample_collected=as.Date(date_sample_collected)) %>% 
  mutate(onset_sample=as.integer(date_sample_collected-date_symptom_onset_final)) %>% 
  #Clean health facility variable
  mutate(health_facility_name=case_when(grepl('KTP', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'MSF / KTP Hospital',
                                      grepl('Leda', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'IOM Leda',
                                      grepl('Hope', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'Hope Foundation / Camp 4',
                                      grepl('BKL', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'MSF OCA BKL',
                                      grepl('5', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'UNHCR / Camp 5',
                                      grepl('8W', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'MSF / Camp 8 W',
                                      questionnaire_answers_health_facility_value=='MR ITC' ~ 'Main Road SARI ITC', 
                                      questionnaire_answers_health_facility_value=='MT ITC' ~ 'Main Road SARI ITC', 
                                      grepl('Main Road SARI ITC', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'Main Road SARI ITC',
                                      grepl('FH-MTI SARI ITC', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'FH-MTI SARI ITC',
                                      TRUE ~ questionnaire_answers_health_facility_value)) %>% 
  #Contact with someone else
  mutate(contact_cov19=case_when(grepl('yes', questionnaire_answers_have_you_had_contact_with_an_anyone_with_suspected_or_confirmed_covid_19_infection, ignore.case=T) ~'Yes',
                                 grepl('no', questionnaire_answers_have_you_had_contact_with_an_anyone_with_suspected_or_confirmed_covid_19_infection, ignore.case=T)  ~'No',
                                 grepl('yes', questionnaire_answers_contact_with_patient, ignore.case=T) ~'Yes',
                                 grepl('no', questionnaire_answers_contact_with_patient, ignore.case=T)  ~'No')) %>% 
           mutate(contact_cov19=factor(contact_cov19, levels=c('Yes', 'No'))) %>% 
  #Smoking history
  mutate(social_event=case_when(grepl('yes', questionnaire_answers_did_the_patient_go_to_any_social_event_party_mass_gathering_religious_services, ignore.case=T) ~'Yes',
                                 grepl('no', questionnaire_answers_did_the_patient_go_to_any_social_event_party_mass_gathering_religious_services, ignore.case=T)  ~'No',
                                 grepl('yes', questionnaire_answers_attended_occasion, ignore.case=T) ~'Yes',
                                 grepl('no', questionnaire_answers_attended_occasion, ignore.case=T)  ~'No')) %>% 
           mutate(social_event=factor(social_event, levels=c('Yes', 'No'))) 

  


```




Column  {data-width=650}
-------------------------------------


### Epi curve of COVID-19 cases by gender

```{r godata_epicurve}

epi_curve <- godata_clean %>% 
  count(date_symptom_onset_final, sex) %>% 
  ggplot(.) +
  geom_col(aes(x = date_symptom_onset_final, y = n, fill=sex)) +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '3 day',
               date_labels = '%d-%m') +
  theme_minimal() +
    scale_fill_brewer(palette="Dark2") +
  labs(x = "Date of symptom onset",
       y = "Number of cases", fill='')

ggplotly(epi_curve)

```


### Cases and deaths by age group


```{r godata_cases_deaths_agegrp}


 case_age <- godata_clean %>% 
    count(age_group, .drop = FALSE) %>% 
    mutate(indicator='Cases')
  
  max_cases <- max(case_age$n)
  
 death_age <- godata_clean %>% 
   filter(outcome=='Dead') %>% 
    count(age_group, .drop = FALSE) %>% 
   mutate(indicator='Deaths')

case_death_age_gph <-  case_age %>% 
   bind_rows(death_age) %>% 
   ggplot(.,
          aes(x = age_group,
              y=n,
              #y = ifelse(sex == 'male', n, -n),
              fill = indicator)) +
   geom_bar(stat = "identity", position = "dodge", width = 0.7) +
   labs(x = "Age group", y = "Count", fill = '') +
   theme_minimal() +
   scale_y_continuous(breaks=seq(0,max_cases,2)) +
    scale_fill_brewer(palette="Dark2") +
   geom_text(
     aes(label = ifelse(n>0,n,''), y = n + 0.05),
     position = position_dodge(0.7),
     vjust = 0
   ) 

ggplotly(case_death_age_gph)
 
```



Column {data-width=350}
-------------------------------------

### Detailed information on cases

```{r}
label(godata_clean$age_years) <- "Age"
label(godata_clean$sex) <- "Sex"
label(godata_clean$outcome) <- "Outcome"
label(godata_clean$questionnaire_answers_travel_outside_camps) <- "Travel outside camp (last 14 days)"
label(godata_clean$status) <- "Status"
#label(godata_clean$risk_level) <- "Risk level"
label(godata_clean$onset_sample) <- "Symptom onest to sample taken (days)"
label(godata_clean$health_facility_name) <- "Health facility"
label(godata_clean$outcome) <- "Patient outcome"
label(godata_clean$contact_cov19) <- "Did the case have contact with a suspected or confirmed COVID-19 case?"
label(godata_clean$any_comorb) <- "Did the case report a pre-existing condition?"
label(godata_clean$detection_status) <- "Status at detection"
label(godata_clean$social_event) <- "Did the case attend a social event/mass gathering before developing symptoms?"
label(godata_clean$any_comorb) <- "Did the case report at least 1 co-morbidity?"


table1(~ age_years  + sex  + 
         detection_status +
         outcome + any_comorb + contact_cov19 + social_event
           , data=godata_clean, topclass="Rtable1-zebra",footnote="Data source: GoData") 

```

### Symptoms at presentation
 
```{r symptom_gph}
symptom_gph <- godata_clean %>% 
    #filter(population_group=='Rohingya refugee/FDMN') %>% 
    #filter(test_result=='Positive') %>% 
    select(id, cough, rapid_breathing, resp_distress, runny_nose, fever,loss_smell,fatigue,loss_appetite,sore_throat,diarrhoea) %>% 
    pivot_longer(-id) %>% 
    filter(value==1) %>% 
    arrange(id, name) %>% 
  mutate(name=case_when(name=='runny_nose' ~ 'Runny nose',
                        name=='rapid_breathing' ~ 'Rapid breathing',
                        name=='resp-distress' ~ 'Respiratory distress',
                        name=='fever' ~ 'Fever', 
                        name=='cough' ~ 'Cough', 
                        name=='fatigue' ~ 'Fatigue',
                        name=='loss_appetite' ~ 'Loss of appetite',
                        name=='sore_throat' ~ 'Sore throat', 
                        name=='diarrhoea' ~ 'Diarrhoea')) %>% 
    select(-value) %>% 
    group_by(id) %>%
    summarize(symptom_list = list(name)) %>% 
    ggplot(aes(x=symptom_list)) +
    geom_bar() +
    theme_bw() +
    labs(x = "",
         y = "Number of cases",
         title="Distribution of symptoms at presentation",
         caption="Data source: GoData") +
    scale_x_upset(n_intersections = 5) +
  scale_y_continuous(breaks= pretty_breaks())

symptom_gph
```
 

Testing {data-orientation=columns}
=====================================  



```{r testing_wrangling}

breaks <- c(-Inf,5,59,Inf)
labs <- c('Under 5', '5 to 59', '60 and over')

ari_ili_df <- gsheet_data$ari_ili %>% 
  clean_names() %>% 
  clean_data() %>% 
  mutate(camp=gsub('camp_', '', camp)) %>% 
  filter(nationality=='fdmn') %>% 
  filter(sample_type!='follow_up') %>% 
  filter(laboratory_result %in% c('positive', 'negative')) %>% 
  mutate(camp_number=str_extract(camp, regexp)) %>% 
  mutate(camp_number=as.numeric(camp_number)) %>% 
  mutate(camp=reorder(camp,camp_number)) %>% 
    mutate(age_group=cut(age,breaks = breaks, labels = labs, right = FALSE)) 


ari_ili_tests_df <- ari_ili_df %>% 
  
  count(date_of_case_detection,camp) %>% 
  complete(date_of_case_detection,camp, fill = list(n = 0)) %>% 
  group_by(camp) %>%
  mutate(cumulative_cases=cumsum(n)) %>%
  mutate(case_growth=ifelse(lag(cumulative_cases,7)>10, 
                            ((cumulative_cases/lag(cumulative_cases,7))^(1/7))-1,NA)) %>%
  mutate(roll_test=roll_mean((n),7,  align="right", fill = NA)) %>% 
  mutate(week=epiweek(date_of_case_detection)) %>% 
  ungroup()

ari_ili_tests_total <- ari_ili_tests_df %>% 
  group_by(camp) %>% 
  summarise(tests_total=sum(n, na.rm=TRUE))

ari_ili_tests_7day <- ari_ili_tests_df %>% 
  filter(date_of_case_detection>=today()-7) %>% 
  group_by(camp) %>% 
  summarise(tests_7day=sum(n, na.rm=TRUE))

ari_ili_tests_growth <- ari_ili_tests_df %>% 
  select(camp, case_growth) %>% 
  group_by(camp) %>% 
  summarise(growth=last(case_growth))

ari_ili_tests_result <- ari_ili_df %>% 
  filter(nationality=='fdmn') %>% 
  count(camp, laboratory_result) %>% 
  group_by(camp) %>% 
  mutate(prop=n/sum(n)) %>% 
  select(-n) %>% 
  pivot_wider(names_from=laboratory_result, values_from=prop) %>% 
  select(camp, positive,negative)




```

Column {data-width=400}
-------------------------------------

### Table of test results

```{r test_camp_table}
tests_table <- ari_ili_tests_total %>% 
  left_join(ari_ili_tests_7day, by='camp') %>% 
  left_join(ari_ili_tests_growth, by='camp') %>% 
  left_join(ari_ili_tests_result, by='camp') %>% 
  mutate(camp=trimws(camp)) %>% 
  mutate(camp_number=str_extract(camp, regexp)) %>% 
  mutate(camp_number=as.numeric(camp_number)) %>% 
  arrange(camp_number) %>% 
  select(-camp_number) %>% 
  select(-c(growth,negative)) %>% 
  mutate(camp=sub("0+", "", camp)) %>% 
  gt() %>% 
  opt_row_striping(., row_striping = TRUE) %>% 
  fmt_percent(
    columns = 4:4,
    decimals = 1
  ) %>% 
  fmt_missing(
    columns = 2:4,
    missing_text = "0%"
  ) %>% 
  cols_label(
    camp = "Camp",
    tests_total = "Total tests",
    tests_7day = "Tests in last 7 days",
    #growth = "7-day growth(%)",
   # negative = "Negative",
    #not_done = "Not complete",
   # pending = "Pending", 
    positive = "Total positive (%)",
    #n_a = 'Result missing'
  ) %>% 
  # tab_spanner(
  #   label = "Test results",
  #   columns = 5:5,
  # ) %>% 
  tab_options(
    container.height = px(1000),
    container.overflow.y = TRUE
    #container.width = px(1000),
    #table.font.size = "small"
  ) 

tests_table

```



Column {data-width=600}
-------------------------------------


### Test positivity by age group

```{r test_pos_agegrp_gph}


tests_gph <- ari_ili_df %>%  
  filter(!laboratory_result %in% c('n_a','not_done')) %>% 
  filter(nationality=='fdmn') %>% 
  count(age_group, laboratory_result) %>% 
  filter(!is.na(age_group)) %>% 
  pivot_wider(names_from=laboratory_result, values_from=n) %>% 
  mutate(total=negative+positive) %>% 
  select(-negative) %>% 
  drop_na() %>% 
  group_by(age_group) %>% 
  mutate(rate = map2(positive, total, ~ prop.test(.x, .y, conf.level=0.95) %>%
                       broom::tidy())) %>%
  unnest(rate) %>% 
  ungroup() %>% 
  ggplot(aes(x=age_group, y=estimate)) +
  geom_point() +
  #coord_flip() +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high), width=.2,
                position = position_dodge(width = 0.1)) +
  theme_minimal() +
  labs(x='Age group', 
       y='% COVID-19 + samples', 
       caption='Data source:ARI/ILI linelist') +
  scale_y_continuous(labels = scales::percent)  +
  theme(legend.position='top')

ggplotly(tests_gph)
```


### Number of tests per 10,000 people by age group

```{r test_per10000_gph}

population <- readxl::read_xlsx(here('data','block_population.xlsx'), sheet='Final', skip=1) %>% 
  clean_names %>%  
  clean_data() %>% 
  filter(grepl('total', camp)) %>% 
  filter(!camp=='grand_total') %>% 
  select(-block) %>% 
  mutate(across(c(infant_below_1:x16), as.numeric)) %>% 
  mutate(age_0_5 = rowSums(.[4:7])) %>% 
  mutate(age_5_59 = rowSums(.[8:13])) %>% 
 # mutate(age_18_59 = rowSums(.[12:13])) %>% 
  mutate(age_over60 = rowSums(.[14:15])) %>% 
  select(camp, contains('total'), contains('age')) %>% 
  mutate(camp=gsub('_total', '', camp)) %>% 
  mutate(camp=gsub('camp_', '', camp)) %>% 
  mutate(camp=trimws(camp)) 


tests_age_group_df <- ari_ili_df %>%  
  filter(!laboratory_result %in% c('n_a','not_done')) %>% 
  filter(nationality=='fdmn') %>% 
  count(age_group, .drop=FALSE) 


age_group_pop <- population %>%  select(-c(total_families, total_individuals)) %>% 
  summarise(across(contains('age'), sum)) %>% 
  pivot_longer(age_0_5:age_over60) %>% 
  mutate(age_group=labs) %>% 
  select(-name)

 tests_age_group_gph <-  tests_age_group_df %>% 
  left_join(age_group_pop, by='age_group') %>% 
   filter(!is.na(age_group)) %>% 
  mutate(tests_per10000=(n/value)*10000) %>% 
  mutate(age_group=factor(age_group, levels=c('Under 5', '5 to 59', '60 and over'))) %>% 
  ggplot(aes(x=age_group, y=tests_per10000, fill=age_group)) +
  geom_col() +
  theme_minimal() +
  theme(legend.position="none") +
  labs(x='Age groups', y='Tests per 10,000 people', fill='Age groups')

 
 ggplotly(tests_age_group_gph)
```


<!---

### Map of testing rates

```{r}
tests_camp_df <- ari_ili_df %>%  
   filter(!laboratory_result %in% c('n_a','not_done')) %>% 
   filter(nationality=='fdmn') %>% 
   filter(!is.na(age)) %>% 
   #mutate(age_group=cut(age,breaks = breaks, labels = labs, right = FALSE)) %>% 
   count(camp, .drop=FALSE) %>% 
   mutate(camp=sub("0+", "", camp)) %>% 
   mutate(camp=trimws(camp))
 
shp_file_fdmn <- shp_file_fdmn %>%  clean_data()

 
tests_camp_per10000_df <- tests_camp_df %>% 
   left_join(population, by='camp') %>% 
  drop_na() %>% 
  mutate(tests_per10000=(n/total_individuals)*10000) %>% 
    select(camp, n, total_individuals,tests_per10000) 


tests_shp_fdmn <- tests_camp_per10000_df %>% 
  mutate(camp=case_when(camp=='kutupalong_rc' ~ 'krc',
                        camp=='nayapara_rc' ~ 'nrc',
                        camp=='4_ext' ~ '4e', 
                        TRUE ~ camp)) %>% 
  #filter(population_group=='Rohingya refugee/FDMN') %>% 
  #filter(!location %in% c('Ukhia', 'Teknaf')) %>% 
  #mutate(code=location) %>% 
  #select(code,total_cases, total_deaths) %>% 
  anti_join(shp_file_fdmn,.,by=c('code'='camp'))

#fdmn.bins <-c(0, 1, 2, 5, 10)

tests_fdmn_pal <- colorBin( "YlOrRd", bins=4, na.color = "grey", domain=tests_shp_fdmn$tests_per10000)
  
tests_popup <- paste(
  "<strong>Camp: </strong>"
  , tests_shp_fdmn$code
  , "<br><strong>Tests per 10,000: </strong>"
  , tests_shp_fdmn$tests_per10000)
  
  leaflet(tests_camp_df) %>% 
  addTiles() %>% 
  addPolygons(data=tests_camp_df,
              color="black",
              fillColor = ~ fdmn_pal(tests_per10000),
              stroke = TRUE,   
              smoothFactor = 0.2,
              popup=popup,
              weight = 1,
              fillOpacity = .6) %>% 
  addLegend("bottomright", pal = fdmn_pal, values = ~host_pal, title = "Number of tests per 10,000 people")

 
```

--->

EWARS - Overall {data-navmenu="All-cause mortality"}  
=====================================  

Inputs {.sidebar}
-------------------------------------

<br>
<br>

<br> 

Data from 2019 are only included from week 30. Before this week, there was low coverage of the data collection tool.  


<br>


Row 
-------------------------------------


### Number of reported deaths per week

```{r ewars_wrangling}
ewars_mort <- read.csv(here('data', 'community_mortality_20200811.csv')) %>% clean_names() %>% 
  mutate(year=as.numeric(isoyear)) %>% 
  mutate(week=as.numeric(isoweek)) %>% 
  mutate(date=make_datetime(year=year) + weeks(week)) %>% 
  filter(date>=ymd('2019-07-01')) %>% 
  mutate(year_wk=yearweek(date)) %>% 
    mutate(year_wk=year_wk-1) %>% 
  arrange(year_wk)  %>% 
  mutate(age_group=case_when(age_in_years<5 ~ 'Under 5',
                             #age_in_years>=5 & age_in_years<15 ~ '5 to 14',
                             age_in_years>=5 & age_in_years<60 ~ '5 to 59',
                             age_in_years>=60 ~'60 and over')) %>% 
  mutate(age_group=factor(age_group, levels=c('Under 5', '5 to 59',  '60 and over', NA)))
```


```{r ewars_mort_gph}
ewars_mort_gph <- ewars_mort %>% 
  #filter(isoyear>2018) %>% 
  #filter(!(isoyear==2019 & isoweek<30)) %>% 
  filter(!camp_zone=='') %>% 
  count(isoyear, isoweek, year_wk) %>%
   group_by(isoyear) %>% 
  mutate(deaths_roll=roll_mean((n),4, na.rm=TRUE, align="right", fill = NA)) %>% 
  ggplot(., aes(x=isoweek, y=deaths_roll, color=factor(isoyear))) +
  #geom_col() +
  #geom_smooth() +
  geom_line() +
  theme_minimal() +
    scale_y_continuous(limits=c(0,40)) +
  labs(x='Week', y='Deaths (4-week average)', color='Year')

ggplotly(ewars_mort_gph)

```


Col 
-------------------------------------

### Deaths by age group

```{r ewars_deaths_agegrp}
death_age_gph <- ewars_mort %>%  
  count(age_group,year_wk) %>% 
  filter(!is.na(age_group)) %>% 
  group_by(age_group) %>% 
  mutate(deaths_roll=roll_mean((n),4, na.rm=TRUE, align="right", fill = NA)) %>% 
  ggplot(aes(x=year_wk, y=deaths_roll, color=fct_rev(age_group))) +
  geom_line() +
    theme_minimal() +
    scale_y_continuous(limits=c(0,40)) +
  labs(x='Week', y='Deaths (4-week average)', color='Age group') +
  scale_colour_brewer(palette = "Set1")

ggplotly(death_age_gph)

```





### Deaths by probable cause of death

```{r ewars_cod}
cause_death_gph <- ewars_mort %>%  
  count(probable_cause_of_death,year_wk) %>% 
  group_by(probable_cause_of_death) %>% 
  mutate(deaths_roll=roll_mean((n),4, na.rm=TRUE, align="right", fill = NA)) %>% 
  ggplot(aes(x=year_wk, y=deaths_roll, color=fct_rev(probable_cause_of_death))) +
  geom_line() +
    theme_minimal() +
      scale_y_continuous(limits=c(0,40)) +
  labs(x='Week', y='Deaths (4-week average)', color='Probable cause of death') +
    scale_colour_brewer(palette = "Set2")


ggplotly(cause_death_gph) %>% layout(legend = list(orientation = "h", x = 0.4, y = -0.2))


```



EWARS - Camp-level {data-navmenu="All-cause mortality"}  
=====================================  

Inputs {.sidebar}
-------------------------------------

<br>
<br>

<br> 

Data from 2019 are only included from week 30. Before this week, there was low coverage of the data collection tool. 

<br>

At the camp-level, spikes are likely due to an increase in partners reporting to the tool not an increase in the number of people dying.   



Column 
-------------------------------------


### Number of reported deaths per week by camp



```{r ewars_deaths_camp}

ewars_mort_camp_gph <-  ewars_mort %>% 
    filter(isoyear>2018) %>% 
    filter(!(isoyear==2019 & isoweek<30)) %>% 
    filter(!camp_zone=='') %>% 
    count(isoyear, isoweek, camp_zone) %>% 
    mutate(camp_number=str_extract(camp_zone, "[[:digit:]]+")) %>% 
    mutate(camp_number=as.numeric(camp_number)) %>% 
    #arrange(camp_number) %>% 
    mutate(camp_zone=reorder(camp_zone, camp_number)) %>% 
    ggplot(., aes(x=isoweek, y=n, color=factor(isoyear))) +
      geom_line() +
      facet_wrap(~camp_zone) +
    theme_minimal() +
   labs(x='Week', y='Count', color='Year')

ggplotly(ewars_mort_camp_gph)


```
<!---

CHW - Overall {data-navmenu="All-cause mortality"}  
=====================================  

CHW - Camp-level {data-navmenu="All-cause mortality"}  
=====================================  

--->



Community-based surveillance 
=====================================  

```{r cbs_wrangling}
hbc_df <- read.csv(here('data', 'home_based_care_20200811.csv')) %>% 
  clean_names() %>% 
  mutate(max_week=max(week)) %>% 
  mutate(camp_number=str_extract(camp, "[[:digit:]]+")) %>% 
  mutate(camp_number=as.numeric(camp_number)) %>% 
  mutate(camp=reorder(camp,camp_number)) %>% 
  filter(week>25)  
  #filter(week<max_week)

```


Inputs {.sidebar}
-------------------------------------

<br>
<br>


Community Health Workers/Volunteers (CHWs) are an outreach workforce consisting of approximately 1400 women and men, primarily Rohingya, who live near or inside the camps. CHWs are each assigned fixed, unique geographic areas with approximately 160 households, which are visited once every two weeks since mid 2018.

<br>

The CHWs use a KoBo Toolbox-based tool, the Community Health Workers Reporting Tool (CHW-RT), to collect data on household indicators.  


<br>



Row  {data-height=500}
-------------------------------------

<br>
<br>


### Households visited

```{r cbs_hhvisited_gph}
hhvisit_gph <- hbc_df %>% 
  select(week, c1_total_hh_visited_week) %>% 
  filter(week>25) %>% 
  group_by(week) %>% 
  summarise(hhvisited=sum(c1_total_hh_visited_week, na.rm=TRUE)) %>% 
  ggplot(., aes(x=week, y=hhvisited)) +
  geom_col() +
  labs(title='Households visited') +
  #labs(x='', y='Households visited') +
  #scale_x_continuous(breaks = c(25, 26, 27, 28, 29)) +
  theme_minimal() 

p <- ggplotly(hhvisit_gph + ylab(" ") + xlab(" "))

x <- list(
  title = "Week"
)
y <- list(
  title = "Households visited"
)
p %>% layout(xaxis = x, yaxis = y)


```

### Proportion of total households reached by community health workers - By camp


```{r cbs_hhvisited_bycamp_gph}

  population <- read.csv(here('data', 'block_level_population.csv'), skip=1) %>% 
    clean_names() %>% select(camp, total_families,total_individuals) %>%
    filter(camp!="") %>% 
    filter(grepl('Total',camp)) %>% 
    mutate(camp_number=str_extract(camp,"[[:digit:]]+")) %>% 
    mutate(camp_number=as.numeric(camp_number)) %>% 
    arrange(camp_number) %>% 
    #Dropped this and summed in next step to confirm it matches
    filter(!camp=='Grand Total') %>% 
    mutate(camp_link=gsub('Camp|Total', '', camp)) %>% 
    mutate(camp_link=trimws(camp_link)) %>% 
    #mutate(camp_link=case_when(camp_link=='4 Ext' ~ '4Ext')) %>% 
    clean_data() %>% 
    select(-camp) %>% 
    rename(camp=camp_link)
  
  
  camp_activity <- hbc_df %>% 
    select(week, camp, c1_total_hh_visited_week, total_yellow_symptoms) %>% 
    ungroup() %>% 
    filter(week>25) %>% 
    mutate(camp=gsub('camp_', '', camp)) %>% 
    mutate(camp_number=str_extract(camp, "[[:digit:]]+")) %>% 
    mutate(camp_number=as.numeric(camp_number)) %>% 
    mutate(camp=reorder(camp, camp_number)) %>% 
    clean_data() %>% 
    mutate(camp=as.character(camp)) %>% 
    #Clean data
    mutate(camp=ifelse(camp=='4ext', '4_ext', 
                       ifelse(camp=='ktp', 'kutupalong_rc',
                              ifelse(camp=='nyp', 'nayapara_rc',
                                     camp)))) %>% 
    group_by(week,camp) %>% 
    summarise(hhvisited=sum(c1_total_hh_visited_week, na.rm=TRUE),
              mild_ind=sum(total_yellow_symptoms, na.rm=TRUE)) %>% 
    ungroup() %>% 
    left_join(population, by=c('camp'='camp')) %>% 
    arrange(camp_number) %>% 
    select(week, camp, hhvisited,mild_ind, total_families,total_individuals, camp_number) %>% 
    mutate(prop_visited=hhvisited/total_families) %>% 
    mutate(prop_mild=mild_ind/total_individuals) %>% 
    mutate(camp=reorder(camp, camp_number)) %>% 
    filter(!is.na(prop_visited)) 

    

prop_visit_camp_gph <-  ggplot(camp_activity, aes(x=week, y=prop_visited)) +
    geom_col() +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~camp) +
    theme(legend.position = "none") +
  theme_minimal() +
    labs(y='Households visited (%)', x='Week')

ggplotly(prop_visit_camp_gph)

```


Row  {data-height=500}
-------------------------------------


### Individuals reporting mild symptoms


```{r cbs_mildsymptoms_gph}
symptoms_df <- hbc_df %>%
  filter(week>25) %>% 
  select(reporting_year, week, contains('sympt')) %>% 
  group_by(reporting_year, week) %>% 
  summarise_all(list(sum)) %>% 
  pivot_longer(-c(reporting_year, week)) %>%
  filter(!grepl('total', name)) %>%
  mutate(symp_level=case_when(grepl('red', name) ~ 'red',
                              grepl('yellow', name) ~ 'yellow')) %>%
  mutate(sex= case_when(grepl('_m_', name) ~ 'male',
                        grepl('_f_', name) ~ 'female')) %>%
  mutate(age_grp=case_when(grepl('5_59', name) ~ '5 to 59',
                           grepl('_60', name) ~ '60 & over',
                           grepl('less_5', name) ~ 'Less than 5')) %>%
  select(-name) %>% 
  mutate(severity=case_when(symp_level=='yellow' ~ 'Mild',
                            symp_level=='red' ~ 'Moderate/Severe')) %>% 
  mutate(age_group=case_when(age_grp=='5 to 59' ~ '5-59',
                             age_grp=='Less than 5' ~ '<5',
                             age_grp=='60 & over' ~ '>=60'))

symptoms_gph <- symptoms_df %>%
  ungroup() %>%
  group_by(severity,week, sex, age_group) %>%
  summarise(total_cases=sum(value,na.rm=TRUE)) %>%
  group_by(severity,week) %>%
  mutate(prop=total_cases/sum(total_cases)) %>%
  mutate(age_group=factor(age_group, levels=c('<5', '5-59', '>=60'))) %>%
  mutate(age_group=fct_rev(age_group)) %>%
  filter(severity=='Mild') %>%
  ggplot(aes(x=week,y=prop, fill=interaction(sex,age_group))) +
  geom_col() +
  #facet_wrap(~severity, ncol=2) +
  theme_minimal() +
  labs(x='Week', y='Proportion of cases', fill='Sex & \n Age group') +
  scale_fill_brewer(palette="Dark2") +
  scale_y_continuous(labels = scales::percent)

ggplotly(symptoms_gph) %>% layout(legend = list(orientation = "h", x = 0.4, y = -0.2))


```

### Individuals reporting moderate/severe symptoms

```{r cbs_modsev_symptoms}

symptoms_df %>% 
  group_by(week, severity, age_grp, sex) %>% 
  summarise(total=sum(value,na.rm=TRUE)) %>% 
  pivot_wider(names_from=c(age_grp,sex), values_from=total) %>% 
  arrange(desc(week)) %>% 
  ungroup() %>% 
  filter(!severity=='Mild') %>% 
  select(-severity) %>% 
  clean_names() %>% 
  select(week, contains('less_than_5'), contains('5_to_59'), contains('60_over')) %>% 
  rowwise %>% 
  mutate(total = sum(c_across(!week))) %>% 
  gt(rowname_col = c("week")) %>% 
  opt_row_striping(., row_striping = TRUE) %>% 
  tab_stubhead('Week') %>% 
  tab_spanner(
    label = "Under 5",
    columns = vars(less_than_5_male,less_than_5_female)) %>% 
  tab_spanner(
    label = "5 to 59",
    columns = vars(x5_to_59_male,x5_to_59_female)) %>% 
  tab_spanner(
    label = "60 and over",
    columns = vars(x60_over_male,x60_over_female)) %>% 
  cols_label(
    week = "Week",
    less_than_5_male = "Male",
    less_than_5_female = "Female",
    x5_to_59_male = "Male",
    x5_to_59_female = "Female",
    x60_over_male = "Male",
    x60_over_female = "Female", 
    total="Total")  


```

Clinical case management  
=====================================  

Row {data-height=650}
-------------------------------------



<br>
<br>

<iframe width='100%' height='100%' src="https://app.powerbi.com/view?r=eyJrIjoiMzE2YmIzYzctMzdiOS00OWI1LWJkODgtZDkyZDdiNTkwNjRkIiwidCI6IjE1MjZjY2Q5LWQ2YjktNDM2MC1iOTk5LTlmMmY4MjE4M2RjNiIsImMiOjl9&pageName=ReportSection714cfb147cef00bc5ea9"  >
</iframe>


SARI ITC & Isolation  {data-orientation=rows}
=====================================  

<br>
<br>

```{r dru_hf}

num_vars <- c('number_of_functional_sari_beds', 'number_of_currently_filled_sari_beds','number_of_expected_sari_discharges_in_next_24_hours',
              'number_of_functional_isolation_beds_non_sari','number_of_currently_filled_isolation_beds_non_sari','number_of_expected_isolation_discharges_in_next_24_hours_non_sari' )

clean_fn <- function(x){
  ifelse(x == "NULL", NA,x)
}



dru_gt_table <- dru_raw %>%
  clean_names() %>% 
  select(timestamp,facility_name, camp, agency_in_charge, currently_accepting_patient_severity, 
         able_to_manage_special_needs_of_covid_19_cases_tick_all_that_apply, contains('sari'), contains('isolation')) %>% 
  mutate(mild=ifelse(grepl('Mild', currently_accepting_patient_severity) , '+', ''),
         moderate=ifelse(grepl('Moderate', currently_accepting_patient_severity) , '+', ''),
         severe=ifelse(grepl('Severe', currently_accepting_patient_severity) , '+', ''),
         paed=ifelse(grepl('Pead|Paed', able_to_manage_special_needs_of_covid_19_cases_tick_all_that_apply) , '+', ''),
         sam=ifelse(grepl('SAM', able_to_manage_special_needs_of_covid_19_cases_tick_all_that_apply) , '+', ''),
         preg=ifelse(grepl('Preg', able_to_manage_special_needs_of_covid_19_cases_tick_all_that_apply) , '+', ''),
         across(num_vars, as.numeric), 
         prop_filled_sari=(ifelse(number_of_currently_filled_sari_beds>0, (number_of_currently_filled_sari_beds/number_of_functional_sari_beds),NA)),
         prop_filled_iso=(ifelse(number_of_currently_filled_isolation_beds_non_sari>0, (number_of_currently_filled_isolation_beds_non_sari/number_of_functional_isolation_beds_non_sari),NA)),
         camp= gsub("Camp", "", camp), 
         count_beds=(number_of_functional_sari_beds+number_of_functional_isolation_beds_non_sari), 
         filled_beds=(number_of_currently_filled_sari_beds+number_of_currently_filled_isolation_beds_non_sari),
         prop_filled_total=filled_beds/count_beds) %>% 
  select(facility_name, camp, mild, moderate, severe, paed, sam, preg,
         number_of_functional_sari_beds,number_of_currently_filled_sari_beds,prop_filled_sari, number_of_expected_sari_discharges_in_next_24_hours,
         number_of_functional_isolation_beds_non_sari,number_of_currently_filled_isolation_beds_non_sari, prop_filled_iso, number_of_expected_isolation_discharges_in_next_24_hours_non_sari, 
         count_beds, filled_beds, prop_filled_total, timestamp) %>% 
  mutate_if(is.numeric, funs(ifelse(is.na(.), 0, .))) %>% 
  gt() %>% 
  opt_row_striping(., row_striping = TRUE) %>% 
  tab_spanner(
    label = "Currently accepting?",
    columns = vars(mild,moderate,severe)
  ) %>% 
  tab_spanner(
    label = "Severe beds",
    columns = vars(number_of_functional_sari_beds, number_of_currently_filled_sari_beds,prop_filled_sari, number_of_expected_sari_discharges_in_next_24_hours)
  ) %>% 
  tab_spanner(
    label = "Isolation beds",
    columns = vars(number_of_functional_isolation_beds_non_sari, number_of_currently_filled_isolation_beds_non_sari,prop_filled_iso, number_of_expected_isolation_discharges_in_next_24_hours_non_sari)
  ) %>% 
  tab_spanner(
    label = "Accepting special needs patients?",
    columns = vars(paed, sam,preg)
  ) %>% 
  tab_footnote(
    footnote = "Expected in next 24 hours",
    locations = cells_column_labels(columns = vars(number_of_expected_sari_discharges_in_next_24_hours,number_of_expected_isolation_discharges_in_next_24_hours_non_sari))
  ) %>% 
  tab_footnote(
    footnote = "Severe Acute Malnutrition",
    locations = cells_column_labels(columns = vars(sam))
  ) %>% 
  tab_footnote(
    footnote = "Postpartum",
    locations = cells_column_labels(columns = vars(preg))
  ) %>% 
  tab_footnote(
    footnote = "Beds with access to 24/7 oxygen",
    locations = cells_column_spanners(spanners = "Severe beds")
  ) %>% 
  # summary_rows(fns = list(Total = ~ sum(.)), columns = vars(number_of_functional_sari_beds,number_of_currently_filled_sari_beds,
  #                                                           count_beds ),
  #              formatter = fmt_number,
  #              decimals = 0,
  #              use_seps = TRUE) %>%
  summary_rows(fns = list(Total = ~ sum(.)), columns = vars(number_of_functional_sari_beds, number_of_currently_filled_sari_beds, number_of_expected_sari_discharges_in_next_24_hours,
                                                            number_of_functional_isolation_beds_non_sari, number_of_currently_filled_isolation_beds_non_sari, number_of_expected_isolation_discharges_in_next_24_hours_non_sari,
                                                            count_beds, filled_beds),
               formatter = fmt_number,
               decimals = 0,
               use_seps = TRUE) %>%
  (function(x) {
    res <- function() x$`_data` %>%
      dplyr::summarize(prop_filled_sari = sum(number_of_currently_filled_sari_beds) / sum(number_of_functional_sari_beds)) %>%
      dplyr::pull(.data$prop_filled_sari)
    
    summary_rows(x, fns = list(Total = ~ res()), columns = vars(prop_filled_sari),
                 formatter = fmt_percent,
                 decimals = 0,
                 use_seps = TRUE)
  }) %>%
  (function(x) {
    res <- function() x$`_data` %>%
      dplyr::summarize(prop_filled_iso = sum(number_of_currently_filled_isolation_beds_non_sari) / sum(number_of_functional_isolation_beds_non_sari)) %>%
      dplyr::pull(.data$prop_filled_iso)
    
    summary_rows(x, fns = list(Total = ~ res()), columns = vars(prop_filled_iso),
                 formatter = fmt_percent,
                 decimals = 0,
                 use_seps = TRUE)
  }) %>%
  (function(x) {
    res <- function() x$`_data` %>%
      dplyr::summarize(prop_filled_total = sum(number_of_currently_filled_isolation_beds_non_sari + number_of_currently_filled_sari_beds) / sum(number_of_functional_isolation_beds_non_sari + number_of_functional_sari_beds)) %>%
      dplyr::pull(.data$prop_filled_total)
    
    summary_rows(x, fns = list(Total = ~ res()), columns = vars(prop_filled_total),
                 formatter = fmt_percent,
                 decimals = 0,
                 use_seps = TRUE)
  }) %>%
  fmt_percent(
    columns = vars(prop_filled_sari,prop_filled_iso,prop_filled_total),
    decimals = 0
  ) %>% 
  fmt_missing(
    columns = 4:18,
    missing_text = ""
  ) %>% 
  cols_label(
    facility_name = "Facility name",
    camp = "Camp",
    mild = "Mild",
    moderate = "Moderate",
    severe = "Severe",
    paed = "Paediatric",
    sam = "SAM",
    preg = "Pregnant/PP",
    number_of_functional_sari_beds = "Functional (n)",
    number_of_currently_filled_sari_beds = "Filled (n)",
    prop_filled_sari = "Filled (%)",
    number_of_expected_sari_discharges_in_next_24_hours = "Discharges (n)",
    number_of_functional_isolation_beds_non_sari = "Functional (n)",
    number_of_currently_filled_isolation_beds_non_sari = "Filled (n)",
    prop_filled_iso = "Filled (%)",
    number_of_expected_isolation_discharges_in_next_24_hours_non_sari = "Discharges (n)",
    count_beds = "Total beds (n)",
    filled_beds = "Total filled (n)",
    prop_filled_total = "Total filled (%)" ,
    timestamp = "Last updated"
  ) %>% 
  data_color(
    columns = vars(prop_filled_sari,prop_filled_iso,prop_filled_total),
    colors = scales::col_numeric(
      "Reds",
      domain = c(0, 1.5), na.color = "grey89")
  ) %>% 
  tab_source_note("Data Source: DRU Live Bed monitoring Google Sheet") %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  tab_options(
    container.overflow.x = TRUE,
    container.overflow.y = TRUE,
    grand_summary_row.background.color = "white")

dru_gt_table
 
```



<!---
{data-orientation=rows data-navmenu="Healthcare facility monitoring" data-icon="fa-list"}
--->

Quarantine  {data-orientation=rows}
=====================================  


```{r isolation}

quar_vars <- c('new_admissions_in_the_last_24_hours_individuals', 'current_occupancy_individuals', 
               'cumulative_contacts_individuals','cumulative_new_arrivals_travellers_individuals', 
               'number_of_rooms_shelters_currently_functional', 'number_of_rooms_shelters_currently_filled')  

quarantine_table <- quarantine_raw %>% clean_names() %>% 
    filter(!is.na(facility_name)) %>% 
  select(location_of_facility, facility_name,supporting_agency, 
         contains("individuals") ,
         number_of_rooms_shelters_currently_functional,number_of_rooms_shelters_currently_filled, timestamp) %>% 
    mutate(across(quar_vars, as.numeric)) %>% 
  mutate(prop_occupancy=number_of_rooms_shelters_currently_filled/number_of_rooms_shelters_currently_functional) %>% 
  gt() %>% 
  opt_row_striping(., row_striping = TRUE) %>% 
  tab_spanner(
    label = "Individuals",
    columns = vars(new_admissions_in_the_last_24_hours_individuals ,current_occupancy_individuals,
                   cumulative_contacts_individuals,cumulative_new_arrivals_travellers_individuals)
  ) %>% 
  tab_spanner(
    label = "Shelters",
    columns = vars(number_of_rooms_shelters_currently_functional,number_of_rooms_shelters_currently_filled,prop_occupancy)
  ) %>% 
  cols_label(
    location_of_facility = "Location",
    facility_name = "Facility name",
    supporting_agency = "Supporting agency",
    new_admissions_in_the_last_24_hours_individuals="New admissions (n)",
    current_occupancy_individuals="Current occupancy (n)",
    cumulative_contacts_individuals="Cumulative contacts (n)",
    cumulative_new_arrivals_travellers_individuals="Cumulative new arrivals (n)",
    number_of_rooms_shelters_currently_functional = "Functional (n)",
    number_of_rooms_shelters_currently_filled = "Filled (n)",
    prop_occupancy = "Filled (%)",
    timestamp="Last updated") %>% 
  summary_rows(fns = list(Total = ~ sum(.)), columns = vars(new_admissions_in_the_last_24_hours_individuals,current_occupancy_individuals,
                                                            cumulative_contacts_individuals,cumulative_new_arrivals_travellers_individuals,
                                                            number_of_rooms_shelters_currently_filled, number_of_rooms_shelters_currently_functional),
               formatter = fmt_number,
               decimals = 0,
               use_seps = TRUE) %>% 
  (function(x) {
    res <- function() x$`_data` %>% 
      dplyr::summarize(prop_occupancy = sum(number_of_rooms_shelters_currently_filled) / sum(number_of_rooms_shelters_currently_functional)) %>% 
      dplyr::pull(.data$prop_occupancy)
    
    summary_rows(x, fns = list(Total = ~ res()), columns = vars(prop_occupancy),
                 formatter = fmt_percent,
                 decimals = 0,
                 use_seps = TRUE)
  }) %>% 
  fmt_percent(
    columns = vars(prop_occupancy),
    decimals = 0
  ) %>% 
   tab_footnote(
    footnote = "In last 24 hours",
    locations = cells_column_labels(columns = vars(new_admissions_in_the_last_24_hours_individuals))
  ) %>% 
  data_color(
    columns = vars(prop_occupancy),
    colors = scales::col_numeric(
      "Reds",
      domain = c(0, 1), na.color = "grey89")
  ) %>% 
  tab_source_note("Data Source: Quarantine monitoring Google Sheet") %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  tab_options(
  container.overflow.x = TRUE,
  container.overflow.y = TRUE,
    grand_summary_row.background.color = "white")



quarantine_table

```


